name: Build ISO and Upload to GCS

on:
  push:
  workflow_dispatch:

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    # we run the arch build inside a docker archlinux container so we have pacman/archiso
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Cache pacman package cache (host -> mounted into container)
        uses: actions/cache@v4
        with:
          path: ${{ runner.temp }}/pacman-pkg-cache
          key: ${{ runner.os }}-pacman-${{ hashFiles('**/build_iso.sh') }}

      - name: Build ISO inside an Arch container
        run: |
          mkdir -p out
          # run archlinux container, mount workspace and the pacman cache from runner temp
          docker run --rm --privileged \
            -v "${{ github.workspace }}":/workspace \
            -v "${{ runner.temp }}/pacman-pkg-cache":/var/cache/pacman/pkg \
            -w /workspace \
            archlinux:latest /bin/bash -lc "
              set -e

              echo '==> Updating base system'
              pacman -Syu --noconfirm

              echo '==> Installing build tools and archiso deps'
              pacman -S --noconfirm grub edk2-shell memtest86+ archiso arch-install-scripts base-devel sudo git curl python3

              echo '==> Creating non-root build user'
              useradd -m builder
              echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers

              echo '==> Building Calamares from AUR as builder'
              su builder -c '
                set -e
                cd /home/builder
                git clone https://aur.archlinux.org/calamares.git
                cd calamares
                # you can tweak flags here if needed
                makepkg -s --noconfirm
              '

              echo '==> Creating local pacman repo (gabeos-local)'
              mkdir -p /workspace/local-repo
              cp /home/builder/calamares/*.pkg.tar.zst /workspace/local-repo/

              cd /workspace/local-repo
              repo-add gabeos-local.db.tar.gz *.pkg.tar.zst

              echo '==> Adding gabeos-local repo to /etc/pacman.conf (highest priority)'
              sed -i \"1i [gabeos-local]\\nSigLevel = Optional TrustAll\\nServer = file:///workspace/local-repo\\n\" /etc/pacman.conf

              echo '==> Sanity: show pacman.conf head'
              head -n 20 /etc/pacman.conf || true

              echo '==> Running ISO build script'
              # run your ISO builder script (must produce out/*.iso in repo workspace)
              ./workspace/build_iso.sh

              echo '==> Fixing permissions on out/'
              chown -R \$(id -u):\$(id -g) out || true
            "

      - name: Authenticate to GCP (Service Account key or WIF)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Install gcloud & gsutil
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          export_default_credentials: true

      - name: Upload ISO to GCS
        env:
          GCP_PROJECT: ${{ secrets.GCP_PROJECT_ID }}
          GCS_BUCKET: ${{ secrets.GCS_BUCKET }}
        run: |
          ISO_FILE=$(ls out/*.iso | head -n1)
          if [ -z "$ISO_FILE" ]; then
            echo "No ISO found in out/*.iso â€” failing"
            exit 1
          fi
          ISO_NAME=$(basename "$ISO_FILE")
          echo "Uploading $ISO_NAME to gs://$GCS_BUCKET/"
          gcloud config set project "$GCP_PROJECT"
          gsutil cp "$ISO_FILE" gs://"$GCS_BUCKET"/"$ISO_NAME"
          echo "Uploaded to: gs://$GCS_BUCKET/$ISO_NAME"
          echo "Public-ish URL (only works if bucket/object is public): https://storage.googleapis.com/$GCS_BUCKET/$ISO_NAME"
