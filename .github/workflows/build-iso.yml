name: Build the legendary GabeISO

on:
  workflow_dispatch:
  push:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux
      options: --privileged

    env:
      SUPABASE_URL: https://your-project-id.supabase.co
      SUPABASE_BUCKET: gabeos
      SUPABASE_TOKEN: ${{ secrets.SUPABASE_TOKEN }}

    steps:
      - name: Checkout the sauce
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache Pacman packages
        uses: actions/cache@v4
        with:
          path: /var/cache/pacman/pkg
          key: ${{ runner.os }}-pacman

      - name: Install build deps
        run: pacman -Syu --noconfirm grub edk2-shell memtest86+ archiso arch-install-scripts base-devel sudo git curl

      - name: Build the ISO
        run: |
          mkdir -p out
          ./build_iso.sh

      - name: Upload ISO to Supabase
        run: |
          ISO=$(ls out/*.iso | head -n 1)
          ISO_NAME=$(basename "$ISO")
          echo "Uploading $ISO_NAME to Supabase..."
          curl -X POST "$SUPABASE_URL/storage/v1/object/$SUPABASE_BUCKET/$ISO_NAME" \
            -H "Authorization: Bearer $SUPABASE_TOKEN" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @"$ISO"
