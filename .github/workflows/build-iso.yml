on:
  schedule:
    - cron: '0 20 1 * 0'
  workflow_dispatch:
  push:

name: Build GabeOS ISO

jobs:
  build:
    name: Build the Legendary GabeISO
    permissions:
      contents: write
    runs-on: ubuntu-latest
    container:
      image: archlinux
      options: --privileged

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Version
        id: version
        run: echo "version=$(date +%Y.%m.%d)" >> "$GITHUB_OUTPUT"

      - name: Install Dependencies
        run: pacman -Sy --noconfirm grub edk2-shell memtest86+ archiso arch-install-scripts git base-devel sudo curl

      - name: Build ISO
        run: ./build_iso.sh

      - name: Upload ISO to tmpfiles.org
        id: upload
        run: |
          ISO=$(ls out/*.iso | head -n 1)
          echo "Uploading $ISO to tmpfiles.org..."
          URL=$(curl -s -F "file=@$ISO" https://tmpfiles.org/api/v1/upload)
          echo "download_url=$URL" >> "$GITHUB_OUTPUT"

      - name: Add Download Link to Summary
        run: |
          echo "## ðŸ§Š GabeOS ISO Build: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Download it here (valid ~60 min):**" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.upload.outputs.download_url }}" >> $GITHUB_STEP_SUMMARY